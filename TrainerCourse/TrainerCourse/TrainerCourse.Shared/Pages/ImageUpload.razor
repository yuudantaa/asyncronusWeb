@using TrainerCourse.Shared.Services
<div class="image-upload-container">
    <div class="form-group">
        <label>Course Image</label>

        @if (!string.IsNullOrEmpty(ImageUrl))
        {
            <div class="image-preview mb-2">
                <img src="@ImageUrl" alt="Course image" class="img-thumbnail" style="max-height: 200px;" />
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" @onclick="RemoveImage">
                    <i class="bi bi-trash"></i> Remove Image
                </button>
            </div>
        }

        <InputFile OnChange="HandleFileSelected" accept=".png,.jpg,.jpeg"
                   class="form-control" />

        @if (IsUploading)
        {
            <div class="mt-2">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Uploading...</span>
                </div>
                <span class="ms-2">Uploading...</span>
            </div>
        }

        @if (!string.IsNullOrEmpty(UploadMessage))
        {
            <div class="alert @(UploadMessage.Contains("success") ? "alert-success" : "alert-danger") mt-2">
                @UploadMessage
            </div>
        }

        <div class="form-text">
            Supported formats: PNG, JPG, JPEG. Maximum size: 5MB.
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? ImageUrl { get; set; }

    [Parameter]
    public string? ImageFileName { get; set; }

    [Parameter]
    public EventCallback<string> ImageUrlChanged { get; set; }

    [Parameter]
    public EventCallback<string> ImageFileNameChanged { get; set; }

    [Inject]
    private ICourseService CourseService { get; set; } = default!;

    private bool IsUploading { get; set; }
    private string UploadMessage { get; set; } = string.Empty;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        IsUploading = true;
        UploadMessage = string.Empty;
        StateHasChanged();

        try
        {
            var result = await CourseService.UploadImageAsync(file);

            if (result.Success)
            {
                ImageFileName = result.FileName;
                ImageUrl = result.ImageUrl;

                await ImageFileNameChanged.InvokeAsync(ImageFileName);
                await ImageUrlChanged.InvokeAsync(ImageUrl);

                UploadMessage = "Image uploaded successfully!";
            }
            else
            {
                UploadMessage = result.Message ?? "Upload failed";
            }
        }
        catch (Exception ex)
        {
            UploadMessage = $"Error uploading image: {ex.Message}";
        }
        finally
        {
            IsUploading = false;
            StateHasChanged();
        }
    }

    private async Task RemoveImage()
    {
        ImageUrl = null;
        ImageFileName = null;

        await ImageUrlChanged.InvokeAsync(null);
        await ImageFileNameChanged.InvokeAsync(null);

        StateHasChanged();
    }
}